{% extends "vbase.html" %}
{% block title %}Order Notification{% endblock %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/new_ord.css' %}">
<h2 class="notif-header">Notifications</h2>
<div class="notif-container">
    <ul class="notif-list">
        {% for notification in notifications %}
            <li class="notif-item">
                <div class="notif-details">
                    <p><strong>Order ID:</strong> <span>{{ notification.order_id }}</span></p>
                    <p><strong>Customer Phone:</strong> <span>{{ notification.customer_phone_number }}</span></p>
                    <p><strong>Vehicle:</strong> <span>{{ notification.vehicle }}</span></p>
                    <p><strong>Date:</strong> <span>{{ notification.date }}</span></p>
                    <p><strong>From:</strong> <span>{{ notification.from_location }}</span></p>
                    <p><strong>To:</strong> <span>{{ notification.to_location }}</span></p>
                    <p><strong>Purpose:</strong> <span>{{ notification.purpose }}</span></p>
                    <p><strong>Item Name:</strong> <span>{{ notification.item_name }}</span></p>
                    <p><strong>Load (kg):</strong> <span>{{ notification.load_kg }}</span></p>
                    <p><strong>Load Image:</strong></p>
                    {% if notification.load_image_url != 'N/A' %}
                        <img src="{{ notification.load_image_url }}" alt="Load Image" class="notif-load-image">
                    {% else %}
                        <p class="notif-no-image">N/A</p>
                    {% endif %}
                    <p><strong>Services:</strong> <span>{{ notification.services }}</span></p>
                    <p><strong>Distance:</strong> <span>{{ notification.distance }}</span></p>
                    <p><strong>Price:</strong> <span>{{ notification.price }}</span></p>
                    <p><strong>Processing Fee:</strong> <span>{{ notification.processing_fee }}</span></p>
                    <p><strong>Labor Info:</strong> <span>{{ notification.labor_info }}</span></p>
                    <p><strong>Status:</strong> <span>{{ notification.status }}</span></p>
                    <p><strong>OTP:</strong> <span>{{ notification.otp }}</span></p>
                    <p><strong>Message:</strong> <span>{{ notification.message }}</span></p>
                    <p><strong>Created At:</strong> <span>{{ notification.created_at }}</span></p>
                </div>
                <div class="notif-actions">
                    <button class="accept-btn" data-order-id="{{ notification.order_id }}">Accept</button>
                    <button class="reject-btn" data-order-id="{{ notification.order_id }}">Reject</button>
                </div>
            </li>
        {% empty %}
            <li class="notif-empty">No new notifications.</li>
        {% endfor %}
    </ul>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('.accept-btn, .reject-btn').click(function() {
            const orderId = $(this).data('order-id');
            const action = $(this).hasClass('accept-btn') ? 'accept' : 'reject';
    
            $.ajax({
                url: '{% url "update_notification_status" %}',  // Update this URL to match your view
                type: 'POST',
                data: {
                    order_id: orderId,
                    action: action,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        if (action === 'accept') {
                            window.location.href = `{% url 'order_opr' %}?order_id=${orderId}`;  // Redirect to the order page
                        } else {
                            location.reload(); // Reload the page for rejection
                        }
                    } else {
                        alert('Failed to update notification status.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error(xhr.responseText);
                    alert('An error occurred. Please try again.');
                }
            });
        });
    });
</script>
{% endblock content %}
