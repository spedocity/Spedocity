{% extends "base.html" %}
{% block title %}Booking{% endblock %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'css/lbook.css' %}">
<br>
<div class="main-container" onload="initMap()">
    <header class="head">
        <h1>Booking Form</h1>
    </header>
    <br>

    <form id="booking-form" method="post" enctype="multipart/form-data" action="{% url 'calculate_price' %}">
        {% csrf_token %}

        <!-- Step 1: Location Inputs -->
        <div class="step active" id="step-1">
            <input type="hidden" id="booking-type" name="booking-type" value="Logistics">

            <div class="form-group">
                <label for="from-location">From:</label>
                <input type="text" id="from-location" name="from-location" placeholder="Enter from location" required>
                <span class="location-link" onclick="getCurrentLocation('from')">Use Current Location</span>
                <div id="current-location-display-from" class="current-location"></div>
            </div>

            <div class="form-group">
                <div id="via-container" class="via-container">
                    <label for="via-location-1">Via (Optional):</label>
                    <span class="via-warning">Add via locations for multiple pick-up points</span>
                    <div class="via-input">
                        <input type="text" id="via-location-1" name="via-location" placeholder="Enter via location">
                        <span class="remove-via" onclick="removeViaField(this)">X</span>
                    </div>
                </div>
                <button type="button" class="add-via-button" onclick="addViaField()">Add More Via</button>
            </div>

            <div class="form-group">
                <label for="to-location">To:</label>
                <input type="text" id="to-location" name="to-location" placeholder="Enter to location" required>
                <span class="location-link" onclick="getCurrentLocation('to')">Use Current Location</span>
                <div id="current-location-display-to" class="current-location"></div>
            </div>

            <div class="form-group">
                <button type="button" onclick="nextStep()">Next</button>
            </div>
        </div>

        <!-- Step 2: Booking Summary -->
        <div class="step" id="step-2">
            <h2>Booking Summary</h2>

            <div class="summary-container">
                <div class="summary-details">
                    <span class="label">From:</span> <span class="info" id="summary-from"></span>
                </div>
                <div id="via-summary-container"></div>
                <div class="summary-details">
                    <span class="label">To:</span> <span class="info" id="summary-to"></span>
                </div>
                <div class="distance-time">
                    <span class="label">Total Distance:</span> <span class="info" id="distance"></span><br>
                    <span class="label">Estimated Time:</span> <span class="info" id="duration"></span>
                </div>
            </div>

            <div id="map"></div>

            <div class="form-group">
                <button type="button" onclick="nextStep()">Next</button>
                <button type="button" onclick="prevStep()">Previous</button>
            </div>
        </div>

        <!-- Step 3: Item Entry Details -->
        <div class="step" id="step-3">
            <h2>Item Details</h2>

            <div class="form-group">
                <label for="item-type">Item Type:</label>
                <input type="text" id="item-type" name="item-type" placeholder="e.g., Furniture, Electronics" required>
                <span class="error" id="nameError">Please enter the item type.</span>
            </div>

            <div class="form-group">
                <label for="item-weight">Item Weight (in kg):</label>
                <input type="number" id="item-weight" name="item-weight" placeholder="Enter weight" required>
                <span class="error" id="loadError">Please enter a valid weight value.</span>
            </div>

            <div class="form-group">
                <label for="itemImage">Upload Item Image:</label>
                <input type="file" id="itemImage" name="itemImage" accept="image/*" required>
                <span class="error" id="imageError">Please upload an image of the item.</span>
            </div>

            <div class="form-group">
                <label>Do you want labor?</label>
                <div class="radio-group">
                    <input type="radio" id="laborYes" name="labor" value="yes" required>
                    <label for="laborYes">Yes</label>
                    <input type="radio" id="laborNo" name="labor" value="no">
                    <label for="laborNo">No</label>
                </div>
                <span class="error" id="laborError">Please select an option.</span>
            </div>

            <div class="form-group" id="laborCountGroup">
                <label for="laborCount">Number of Labors:</label>
                <select id="laborCount" name="laborCount">
                    <option value="" disabled selected>Select number of labors</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <span class="error" id="laborCountError">Please select the number of laborers.</span>
            </div>

            <div id="noLaborMessage">No labor selected...!</div>

            <div class="form-group">
                <button type="submit">Submit Booking</button>
                <button type="button" onclick="prevStep()">Previous</button>
            </div>
        </div>

        <!-- Step 4: Choose Vehicle Category -->
        <div class="step" id="step-4">
            <h2>Select Vehicle Category</h2>
            <section id="categories-container" class="vehicle-container">
                <!-- Vehicle categories will be dynamically inserted here -->
            </section>
            <div class="form-group">
                <button class="book-now" type="button" onclick="confirmBooking()">Confirm Booking</button>
                <button type="button" onclick="prevStep()">Previous</button>
            </div>
        </div>
    </form>
    <!-- Loading spinner (placed outside the form) -->
<!-- Loading spinner with timer (placed outside the form) -->
<div id="loading" style="display: none;">
    <p>Waiting for driver confirmation...</p>
    <div class="spinner"></div>
    <p id="timer">Time remaining: 2:00</p> <!-- Timer display -->
</div>
</div>

<br>
<script>
const calculatePriceUrl = "{% url 'calculate_price' %}";
const confirmBookingUrl = "{% url 'confirm_booking' %}";
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2aKVzC3za4z7PzGuiHh0evvFdx4agki0&libraries=places"></script>
<script src="{% static 'js/lbook.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{% endblock %}
