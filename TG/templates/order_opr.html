{% extends "vbase.html" %}
{% block title %}Order{% endblock %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/order_opr.css' %}">
<div class="container">
    <h2>Order Page</h2>

    <div class="form-group">
        <label>Order ID:</label>
        <span id="orderId">{{ order_id }}</span>
    </div>

    <div class="form-group">
        <label>Customer Name:</label>
        <span id="customerName">{{ customer_name }}</span>
    </div>

    <div class="form-group">
        <label>Customer Number:</label>
        <div class="copy-container">
            <span class="customer-info">
                <div id="customerNumber">{{ customer_number }}</div>
                <div class="copy-icon" onclick="copyNumber()">ðŸ“‹</div>
            </span>
        </div>
    </div>

    <div class="form-group">
        <label>From Location:</label>
        <span id="fromLocation">{{ from_location }}</span>
    </div>

    <div class="form-group">
        <label>To Location:</label>
        <span id="toLocation">{{ to_location }}</span>
    </div>

    <div class="form-group">
        <label>Distance (km):</label>
        <span id="distance">{{ distance }}</span>
    </div>

    <div class="form-group">
        <label>Price (â‚¹):</label>
        <span id="price">{{ price }}</span>
    </div>

    <div class="form-group">
        <label>Processing Fee(â‚¹):</label>
        <span id="price">{{ processing_fee}}</span>
    </div>

    <div class="form-group">
        <label>Total Waiting Time Charge (â‚¹):</label>
        <span id="waitingTimeCharge">{{ total_waiting_time_price }}</span>
    </div>

    <div class="form-group">
        <label>Item Name:</label>
        <span id="itemName">{{ item_name }}</span>
    </div>

    <div class="form-group">
        <label>Item Load (kg):</label>
        <span id="itemLoad">{{ item_load }}</span>
    </div>

    <div class="form-group">
        <div>
            <label>Item Image:</label>
            <div class="image-container">
                <img src="{{ item_image_url }}" alt="Item" class="item-image" id="itemImage" />
            </div>
        </div>
        <div class="verification-container">
            <input type="checkbox" 
                   id="verificationBox" 
                   class="checkbox" 
                   onclick="sendVerification()"
                   {% if verified %} checked {% endif %} />  <!-- Check if verified -->
            <span class="verified-text" id="verifiedText">{% if verified %} Verified {% else %} Not Verified {% endif %}</span>
        </div>
    </div>

    <!-- OTP Section -->
    <div id="otpSection" style="display: {% if otp_verified %}none{% else %}block{% endif %};">
        <label for="otpInput">Enter OTP</label>
        <input type="number" id="otpInput" placeholder="Enter OTP">
        <button class="btn" onclick="validateOtp()">Validate OTP</button>
    </div>
    
    <!-- Message Section -->
    <p id="otpMessage" style="color: green; display: none;">
        OTP is verified successfully.
    </p>

    <br>
    <div class="form-group">
        <label>Waiting Time:</label>
        <span id="waitingTime">00:00:00</span>
    </div>
    <div class="form-group">
        <button class="btn" onclick="startWaitingTime()" id="startButton">Start Waiting Time</button>
        <button class="btn" onclick="stopWaitingTime()" id="stopButton">Stop Waiting Time</button>
    </div>
    

    <div style="margin-top: 20px;"></div>

    <div class="form-group">
        <label>Total Price (â‚¹):</label>
        <span id="totalPrice">{{ total_price }}</span>
    </div>

    <div class="form-group">
        <label>Status:</label>
        <select id="status">
            <option value="booking" {% if status == 'booking' %}selected{% endif %}>Booking</option>
            <option value="confirmed" {% if status == 'confirmed' %}selected{% endif %}>Confirmed</option>
            <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>In Progress</option>
            <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
        </select>
    </div>
   

    <div class="save-container">
        <button class="btn" onclick="saveOrder()">Save Order</button>
        <p id="saveMessage" class="status"></p>
    </div>
</div>
<script>
    let waitingSeconds = 0;
    let waitingTimeInterval;
    let waitingTimeId;

    // Format seconds into HH:MM:SS
    function formatTime(seconds) {
        const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${hrs}:${mins}:${secs}`;
    }

    // Start waiting time function
    function startWaitingTime() {
        waitingSeconds = 0; // Reset counter
        document.getElementById('waitingTime').innerText = formatTime(waitingSeconds);

        $.ajax({
            url: '{% url "start_waiting_time" %}',  // Define this URL in urls.py
            type: 'POST',
            data: {
                order_id: document.getElementById('orderId').innerText,  // Ensure `orderId` is available in your HTML
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    waitingTimeId = response.waiting_time_id;
                    document.getElementById("startButton").disabled = true;
                    document.getElementById("stopButton").disabled = false;

                    // Start the interval timer to update waiting time every second
                    waitingTimeInterval = setInterval(() => {
                        waitingSeconds++;
                        document.getElementById('waitingTime').innerText = formatTime(waitingSeconds);
                    }, 1000);
                } else {
                    alert("Failed to start waiting time. Please try again.");
                }
            },
            error: function() {
                alert("Error starting waiting time.");
            }
        });
    }

    // Stop waiting time function
    function stopWaitingTime() {
        clearInterval(waitingTimeInterval);

        $.ajax({
            url: '{% url "stop_waiting_time" %}',  // Define this URL in urls.py
            type: 'POST',
            data: {
                waiting_time_id: waitingTimeId,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    document.getElementById("startButton").disabled = false;
                    document.getElementById("stopButton").disabled = true;

                    // Display the final duration in the alert or on the page
                    alert("Waiting time stopped. Duration: " + response.duration);
                } else {
                    alert("Failed to stop waiting time. Please try again.");
                }
            },
            error: function() {
                alert("Error stopping waiting time.");
            }
        });
    }
    function copyNumber() {
        const number = document.getElementById("customerNumber").innerText;
        navigator.clipboard.writeText(number)
          .then(() => alert("Number copied to clipboard!"))
          .catch(err => alert("Failed to copy number: ", err));
      }
  
      function validateOtp() {
        const orderId = document.getElementById('orderId').innerText;
        const otpInput = document.getElementById('otpInput').value;
        const otpMessage = document.getElementById('otpMessage');
        const otpSection = document.getElementById('otpSection');
        
        // Clear any previous messages
        otpMessage.innerHTML = '';
        otpMessage.style.display = 'none';  // Hide message initially
    
        console.log("OTP Validation started");
    
        $.ajax({
            url: '{% url "validate_otp" %}',
            type: 'POST',
            data: {
                order_id: orderId,
                otp: otpInput,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log("AJAX Response:", response);
                if (response.success) {
                    otpMessage.innerHTML = `<span style="color: green;">${response.message}</span>`;
                    otpMessage.style.display = 'block';  // Show success message
                    otpSection.style.display = 'none';  // Hide the OTP input section
                    
                    // Refresh the page after successful OTP validation
                    setTimeout(() => {
                        location.reload();  // Reload the page
                    }, 1000);  // Optional: Delay the reload for 1 second
                } else {
                    otpMessage.innerHTML = `<span style="color: red;">${response.message}</span>`;
                    otpMessage.style.display = 'block';  // Show error message
                    alert(response.message);  // Show alert for invalid OTP
                }
            },
            error: function(xhr, status, error) {
                console.log("AJAX Error:", xhr.responseText);
                otpMessage.innerHTML = `<span style="color: red;">An error occurred. Please try again.</span>`;
                otpMessage.style.display = 'block';  // Show error message
                alert("An error occurred. Please try again.");  // Show alert for AJAX error
            }
        });
    }
    function saveOrder() {
        var status = document.getElementById('status').value;
        var orderId = document.getElementById('orderId').innerText;
    
        console.log("Order ID:", orderId);  // Debugging line
    
        $.ajax({
            url: '{% url "update_order_status" %}',
            type: 'POST',
            data: {
                'order_id': orderId,
                'status': status,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    $('#saveMessage').text('Order status updated successfully').css('color', 'green');
                    
                    // Display alert and redirect if provided
                    if (response.redirect_url && response.alert_message) {
                        alert(response.alert_message);  // Show alert message
                        window.location.href = response.redirect_url;  // Redirect to the given URL
                    }
                } else {
                    $('#saveMessage').text('Failed to update status: ' + response.message).css('color', 'red');
                }
            },
            error: function(xhr, status, error) {
                $('#saveMessage').text('An error occurred: ' + error).css('color', 'red');
                console.error("AJAX Error:", xhr, status, error);
            }
        });
    }
    function sendVerification() {
        const isVerified = document.getElementById('verificationBox').checked; // Boolean value (true/false)
        const orderId = document.getElementById('orderId').innerText; // Fetch the order ID
        
        // Prepare the data to be sent
        const data = {
            order_id: orderId,
            verified: isVerified, // True if checked, false if not
            csrfmiddlewaretoken: '{{ csrf_token }}' // Include CSRF token
        };
    
        $.ajax({
            url: '{% url "save_verification_status" %}', // Update with the correct URL for your view
            type: 'POST',
            data: data,
            success: function(response) {
                if (response.success) {
                    console.log("Verification status saved successfully:", response.message);
                    // Optionally update the UI or show a message
                } else {
                    console.error("Failed to save verification status:", response.message);
                    alert('Error: ' + response.message); // Show error message
                }
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error:", xhr.responseText);
                alert("An error occurred while saving verification status. Please try again.");
            }
        });
    }
    let pollingInterval;  // Variable to store the polling interval

function startPolling() {
    pollingInterval = setInterval(checkOrderStatus, 5000);  // Check every 5 seconds
}

function checkOrderStatus() {
    const orderId = document.getElementById('orderId').innerText;  // Fetch order ID

    $.ajax({
        url: '{% url "check_order_status" %}',  // Update with your status check URL
        type: 'GET',
        data: {
            order_id: orderId,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                const status = response.status;  // Assuming the response contains the status

                // Check for specific statuses
                if (status === 'in_progress') {
                    clearInterval(pollingInterval);  // Stop polling
                } else if (status === 'cancelled') {
                    clearInterval(pollingInterval);  // Stop polling
                    alert('Order is cancelled by the customer.');  // Notify user
                    window.location.href = '{% url "vhome" %}';
                }
            } else {
                console.error("Error fetching order status:", response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error("Polling error:", xhr.responseText);
        }
    });
}

// Start polling when the page is loaded or at a specific event
startPolling();
</script>
{% endblock content %}